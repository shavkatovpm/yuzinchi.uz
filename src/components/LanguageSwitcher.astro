---
import { languages, getLangFromUrl, getAlternateLinks } from '../i18n/utils';

const currentLang = getLangFromUrl(Astro.url);
const alternateLinks = getAlternateLinks(Astro.url);
---

<div class="relative" id="lang-switcher">
  <button
    type="button"
    class="flex items-center gap-1.5 rounded-lg border border-dark/10 bg-light px-3 py-2 text-sm font-medium text-dark transition-colors hover:bg-dark/5 dark:border-light/10 dark:bg-dark dark:text-light dark:hover:bg-light/5"
    aria-expanded="false"
    aria-haspopup="true"
  >
    <span class="uppercase">{currentLang}</span>
    <svg class="h-4 w-4 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
    </svg>
  </button>

  <div
    class="absolute right-0 top-full z-50 mt-2 hidden min-w-[120px] overflow-hidden rounded-lg border border-dark/10 bg-light shadow-lg dark:border-light/10 dark:bg-dark"
    id="lang-dropdown"
  >
    {alternateLinks.map(({ lang, url }) => (
      <a
        href={url}
        class:list={[
          'flex items-center gap-2 px-4 py-2.5 text-sm transition-colors',
          lang === currentLang
            ? 'bg-accent/10 text-accent'
            : 'text-dark hover:bg-dark/5 dark:text-light dark:hover:bg-light/5'
        ]}
      >
        <span class="uppercase font-medium">{lang}</span>
        <span class="text-dark/60 dark:text-light/60">{languages[lang]}</span>
      </a>
    ))}
  </div>
</div>

<script>
  function initLangSwitcher() {
    const switcher = document.getElementById('lang-switcher');
    const button = switcher?.querySelector('button');
    const dropdown = document.getElementById('lang-dropdown');

    if (!button || !dropdown) return;

    button.addEventListener('click', (e) => {
      e.stopPropagation();
      const isOpen = dropdown.classList.toggle('hidden');
      button.setAttribute('aria-expanded', String(!isOpen));

      // Rotate arrow
      const arrow = button.querySelector('svg');
      arrow?.classList.toggle('rotate-180', !isOpen);
    });

    // Close on click outside
    document.addEventListener('click', () => {
      dropdown.classList.add('hidden');
      button.setAttribute('aria-expanded', 'false');
      button.querySelector('svg')?.classList.remove('rotate-180');
    });

    // Close on Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        dropdown.classList.add('hidden');
        button.setAttribute('aria-expanded', 'false');
        button.querySelector('svg')?.classList.remove('rotate-180');
      }
    });
  }

  initLangSwitcher();
  document.addEventListener('astro:after-swap', initLangSwitcher);
</script>
