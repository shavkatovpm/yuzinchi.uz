---
import ThemeToggle from './ThemeToggle.astro';
import LanguageSwitcher from './LanguageSwitcher.astro';
import { getLangFromUrl, useTranslations, pageUrls } from '../i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const urls = pageUrls[lang];

const navigation = [
  { name: t('nav.home'), href: urls.home },
  { name: t('nav.services'), href: urls.services },
  { name: t('nav.blog'), href: urls.blog },
  { name: t('nav.contact'), href: urls.contact },
];

const mobileCards = [
  {
    label: t('nav.services'),
    href: urls.services,
    bgColor: '#628141',
    icon: `<path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 006 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0118 16.5h-2.25m-7.5 0h7.5m-7.5 0l-1 3m8.5-3l1 3m0 0l.5 1.5m-.5-1.5h-9.5m0 0l-.5 1.5" />`
  },
  {
    label: t('nav.blog'),
    href: urls.blog,
    bgColor: '#4a6331',
    icon: `<path stroke-linecap="round" stroke-linejoin="round" d="M12 7.5h1.5m-1.5 3h1.5m-7.5 3h7.5m-7.5 3h7.5m3-9h3.375c.621 0 1.125.504 1.125 1.125V18a2.25 2.25 0 01-2.25 2.25M16.5 7.5V18a2.25 2.25 0 002.25 2.25M16.5 7.5V4.875c0-.621-.504-1.125-1.125-1.125H4.125C3.504 3.75 3 4.254 3 4.875V18a2.25 2.25 0 002.25 2.25h13.5M6 7.5h3v3H6v-3z" />`
  },
  {
    label: t('nav.contact'),
    href: urls.contact,
    bgColor: '#374a24',
    icon: `<path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" />`
  }
];

const currentPath = Astro.url.pathname;
---

<header class="sticky top-0 z-50 border-b border-dark/5 bg-light/80 backdrop-blur-lg dark:border-light/5 dark:bg-dark/80">
  <nav class="container-custom">
    <div class="flex h-16 items-center justify-between md:h-20">
      <!-- Logo -->
      <a href={urls.home} class="flex items-center gap-2 text-xl">
        <span class="text-2xl font-black text-accent">100</span>
        <span class="font-bold text-accent">Yuzinchi</span>
      </a>

      <!-- Desktop Navigation -->
      <div class="hidden items-center gap-1 md:flex">
        {navigation.map((item) => (
          <a
            href={item.href}
            class:list={[
              'rounded-lg px-4 py-2 text-sm font-medium transition-colors',
              currentPath === item.href || currentPath.startsWith(item.href + '/')
                ? 'text-dark dark:text-light'
                : 'text-dark/70 hover:bg-dark/5 hover:text-dark dark:text-light/70 dark:hover:bg-light/5 dark:hover:text-light'
            ]}
          >
            {item.name}
          </a>
        ))}
      </div>

      <!-- Right side actions -->
      <div class="flex items-center gap-2">
        <LanguageSwitcher />
        <ThemeToggle />

        <!-- Mobile menu button -->
        <button
          type="button"
          class="relative z-50 flex h-10 w-10 flex-col items-center justify-center gap-1.5 rounded-lg border border-dark/10 text-dark transition-colors hover:bg-dark/5 dark:border-light/10 dark:text-light dark:hover:bg-light/5 md:hidden"
          id="mobile-menu-button"
          aria-expanded="false"
          aria-label="Toggle menu"
        >
          <span class="hamburger-line h-0.5 w-5 bg-current transition-all duration-300"></span>
          <span class="hamburger-line h-0.5 w-5 bg-current transition-all duration-300"></span>
        </button>
      </div>
    </div>
  </nav>
</header>

<!-- Mobile Card Navigation Overlay -->
<div id="mobile-nav-overlay" class="pointer-events-none fixed inset-0 z-40 bg-dark/50 opacity-0 backdrop-blur-sm transition-opacity duration-300 md:hidden"></div>

<div id="mobile-card-nav" class="fixed left-4 right-4 top-20 z-40 overflow-hidden rounded-2xl bg-light shadow-2xl dark:bg-dark md:hidden" style="height: 0px;">
  <div class="flex flex-col gap-3 p-4" id="mobile-cards-container">
    {mobileCards.map((card, idx) => (
      <a
        href={card.href}
        class="nav-card flex items-center gap-4 rounded-xl p-4 text-light transition-transform hover:scale-[1.02]"
        style={`background-color: ${card.bgColor};`}
        data-card-index={idx}
      >
        <div class="flex h-12 w-12 items-center justify-center rounded-lg bg-white/20">
          <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" set:html={card.icon} />
        </div>
        <div class="flex flex-1 items-center justify-between">
          <span class="text-lg font-semibold">{card.label}</span>
          <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 19.5l15-15m0 0H8.25m11.25 0v11.25" />
          </svg>
        </div>
      </a>
    ))}

    <!-- Home link at bottom -->
    <a
      href={urls.home}
      class="nav-card mt-2 flex items-center justify-center gap-2 rounded-xl border border-dark/10 bg-light p-4 text-dark transition-colors hover:bg-dark/5 dark:border-light/10 dark:bg-dark dark:text-light dark:hover:bg-light/5"
      data-card-index="3"
    >
      <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
      </svg>
      <span class="font-medium">{t('nav.home')}</span>
    </a>
  </div>
</div>

<style>
  /* Hamburger animation */
  #mobile-menu-button.open .hamburger-line:first-child {
    transform: translateY(4px) rotate(45deg);
  }

  #mobile-menu-button.open .hamburger-line:last-child {
    transform: translateY(-4px) rotate(-45deg);
  }

  /* Card initial state for animation */
  .nav-card {
    opacity: 0;
    transform: translateY(30px);
  }

  /* When menu is open */
  #mobile-card-nav.open .nav-card {
    opacity: 1;
    transform: translateY(0);
  }
</style>

<script>
  import { gsap } from 'gsap';

  function initMobileMenu() {
    const button = document.getElementById('mobile-menu-button');
    const overlay = document.getElementById('mobile-nav-overlay');
    const cardNav = document.getElementById('mobile-card-nav');
    const cards = document.querySelectorAll('.nav-card');

    if (!button || !overlay || !cardNav || !cards.length) return;

    let isOpen = false;
    let tl: gsap.core.Timeline | null = null;

    // Calculate menu height
    const calculateHeight = () => {
      const cardsContainer = document.getElementById('mobile-cards-container');
      if (!cardsContainer) return 300;

      // Temporarily show to measure
      const wasHeight = cardNav.style.height;
      cardNav.style.height = 'auto';
      const height = cardsContainer.offsetHeight;
      cardNav.style.height = wasHeight;

      return height;
    };

    // Create animation timeline
    const createTimeline = () => {
      const timeline = gsap.timeline({ paused: true });

      // Reset initial states
      gsap.set(cardNav, { height: 0, overflow: 'hidden' });
      gsap.set(cards, { y: 30, opacity: 0 });

      // Animate menu height
      timeline.to(cardNav, {
        height: calculateHeight,
        duration: 0.4,
        ease: 'power3.out'
      });

      // Animate cards with stagger
      timeline.to(cards, {
        y: 0,
        opacity: 1,
        duration: 0.4,
        ease: 'power3.out',
        stagger: 0.08
      }, '-=0.2');

      return timeline;
    };

    // Initialize timeline
    tl = createTimeline();

    const toggleMenu = () => {
      if (!tl) return;

      if (!isOpen) {
        // Open menu
        isOpen = true;
        button.classList.add('open');
        button.setAttribute('aria-expanded', 'true');
        overlay.classList.remove('pointer-events-none', 'opacity-0');
        overlay.classList.add('pointer-events-auto', 'opacity-100');
        cardNav.classList.add('open');
        tl.play(0);
      } else {
        // Close menu
        button.classList.remove('open');
        button.setAttribute('aria-expanded', 'false');
        overlay.classList.add('opacity-0');
        overlay.classList.remove('opacity-100');

        tl.eventCallback('onReverseComplete', () => {
          isOpen = false;
          overlay.classList.add('pointer-events-none');
          overlay.classList.remove('pointer-events-auto');
          cardNav.classList.remove('open');
        });
        tl.reverse();
      }
    };

    // Event listeners
    button.addEventListener('click', toggleMenu);
    overlay.addEventListener('click', () => {
      if (isOpen) toggleMenu();
    });

    // Close menu on card click
    cards.forEach(card => {
      card.addEventListener('click', () => {
        if (isOpen) {
          // Small delay before navigation for smooth animation
          setTimeout(() => {
            toggleMenu();
          }, 100);
        }
      });
    });

    // Handle resize
    const handleResize = () => {
      if (window.innerWidth >= 768 && isOpen) {
        // Close menu on desktop
        gsap.set(cardNav, { height: 0 });
        gsap.set(cards, { y: 30, opacity: 0 });
        button.classList.remove('open');
        button.setAttribute('aria-expanded', 'false');
        overlay.classList.add('pointer-events-none', 'opacity-0');
        overlay.classList.remove('pointer-events-auto', 'opacity-100');
        cardNav.classList.remove('open');
        isOpen = false;
        tl = createTimeline();
      }
    };

    window.addEventListener('resize', handleResize);

    // Cleanup function
    return () => {
      button.removeEventListener('click', toggleMenu);
      overlay.removeEventListener('click', toggleMenu);
      window.removeEventListener('resize', handleResize);
      tl?.kill();
    };
  }

  // Initialize
  initMobileMenu();
  document.addEventListener('astro:after-swap', initMobileMenu);
</script>
