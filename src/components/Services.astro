---
import { getLangFromUrl, useTranslations, serviceUrls } from '../i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const urls = serviceUrls[lang];

// Instagram icon - minimalistic camera
const instagramIcon = `<rect x="3" y="3" width="18" height="18" rx="5" ry="5" fill="none" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="12" r="4" fill="none" stroke="currentColor" stroke-width="2"/><circle cx="17.5" cy="6.5" r="1.5" fill="currentColor"/>`;

// Telegram icon - minimalistic paper plane
const telegramIcon = `<path d="M22 2L11 13" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M22 2L15 22L11 13L2 9L22 2Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>`;

// Google icon - minimalistic search/target
const googleIcon = `<circle cx="11" cy="11" r="8" fill="none" stroke="currentColor" stroke-width="2"/><path d="M21 21L16.65 16.65" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>`;

const services = [
  {
    icon: instagramIcon,
    title: 'Instagram Target',
    href: urls.instagram,
    what: t('services.instagram.what'),
    forWhom: t('services.instagram.forWhom'),
    result: t('services.instagram.result')
  },
  {
    icon: telegramIcon,
    title: 'Telegram Ads',
    href: urls.telegram,
    what: t('services.telegram.what'),
    forWhom: t('services.telegram.forWhom'),
    result: t('services.telegram.result')
  },
  {
    icon: googleIcon,
    title: 'Google Ads',
    href: urls.google,
    what: t('services.google.what'),
    forWhom: t('services.google.forWhom'),
    result: t('services.google.result')
  }
];
---

<section class="section-padding">
  <div class="mx-auto max-w-[95%] px-2 sm:px-4">
    <!-- Services container with green border - almost full width -->
    <div class="rounded-3xl border-2 border-accent p-4 sm:p-6 md:p-8">
      <!-- Header inside border -->
      <div class="mx-auto max-w-3xl text-center mb-8 md:mb-14">
        <h2 class="text-3xl font-bold text-light md:text-4xl">
          {t('services.title')}
        </h2>
      </div>

      <!-- Mobile: Accordion cards -->
      <div class="flex flex-col gap-3 md:hidden">
        {services.map((service, index) => (
          <div
            class="service-card group rounded-2xl border border-light/10 bg-dark/50 overflow-hidden transition-all duration-300"
            data-service-card
            data-href={service.href}
          >
            <!-- Header (always visible) -->
            <button
              type="button"
              class="flex w-full items-start justify-between gap-3 p-5 text-left"
              data-service-trigger
            >
              <div class="flex items-start gap-3 flex-1 min-w-0">
                <div class="inline-flex h-12 w-12 shrink-0 items-center justify-center rounded-xl bg-accent/10 mt-0.5">
                  <svg class="h-6 w-6 text-accent" viewBox="0 0 24 24" set:html={service.icon} />
                </div>
                <div class="flex-1 min-w-0">
                  <h3 class="text-lg font-bold text-light mb-2">
                    {service.title}
                  </h3>
                  <p class="text-sm text-light/60 leading-relaxed">{service.what}</p>
                </div>
              </div>
              <svg
                class="h-5 w-5 shrink-0 text-accent transition-transform duration-300 mt-1"
                data-service-icon
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
              >
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
              </svg>
            </button>

            <!-- Expandable content -->
            <div
              class="grid grid-rows-[0fr] transition-all duration-300 ease-out"
              data-service-content
            >
              <div class="overflow-hidden">
                <div class="px-4 pb-4 space-y-4">
                  <!-- For whom & Results - unified background -->
                  <div class="rounded-xl bg-light/5 p-3 space-y-4">
                    <!-- For whom -->
                    <div>
                      <div class="mb-1 flex items-center gap-2">
                        <div class="flex h-5 w-5 items-center justify-center rounded-full bg-accent/10">
                          <svg class="h-3 w-3 text-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                          </svg>
                        </div>
                        <span class="text-xs font-semibold text-light/80">{t('services.label.forWhom')}</span>
                      </div>
                      <p class="text-sm text-light/70">{service.forWhom}</p>
                    </div>

                    <!-- Results -->
                    <div class="border-t border-light/10 pt-4">
                      <div class="mb-1 flex items-center gap-2">
                        <div class="flex h-5 w-5 items-center justify-center rounded-full bg-accent/10">
                          <svg class="h-3 w-3 text-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                          </svg>
                        </div>
                        <span class="text-xs font-semibold text-light/80">{t('services.label.result')}</span>
                      </div>
                      <p class="text-sm text-light/70">{service.result}</p>
                    </div>
                  </div>

                  <!-- CTA Button -->
                  <a
                    href={service.href}
                    class="flex items-center justify-center gap-2 rounded-xl bg-accent py-3 text-sm font-semibold text-light transition-all duration-300 hover:bg-accent/90"
                  >
                    {t('services.learnMore')}
                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                    </svg>
                  </a>
                </div>
              </div>
            </div>
          </div>
        ))}
      </div>

      <!-- Desktop: Grid cards (unchanged) -->
      <div class="hidden md:grid mx-auto max-w-5xl gap-5 md:grid-cols-3">
        {services.map((service) => (
          <a
            href={service.href}
            class="group relative flex flex-col overflow-hidden rounded-2xl border border-light/10 bg-dark/50 p-5 transition-all duration-300 ease-out hover:border-accent/30 hover:shadow-xl hover:shadow-accent/10"
          >
            <!-- Accent background on hover -->
            <div class="absolute inset-0 bg-accent opacity-0 transition-opacity duration-300 ease-out group-hover:opacity-5"></div>

            <div class="relative flex flex-1 flex-col">
              <!-- Icon + Title row -->
              <div class="mb-5 flex items-center gap-3">
                <div class="inline-flex h-12 w-12 shrink-0 items-center justify-center rounded-xl bg-accent/10">
                  <svg class="h-6 w-6 text-accent" viewBox="0 0 24 24" set:html={service.icon} />
                </div>
                <h3 class="text-xl font-bold text-light">
                  {service.title}
                </h3>
              </div>

              <!-- 3 Info Sections -->
              <div class="flex-1">
                <!-- What is it -->
                <div class="min-h-[94px] border-b border-light/10 pb-4">
                  <div class="mb-1 flex items-center gap-2">
                    <div class="flex h-5 w-5 items-center justify-center rounded-full bg-accent/10">
                      <svg class="h-3 w-3 text-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                    </div>
                    <span class="text-xs font-semibold text-light/80">{t('services.label.what')}</span>
                  </div>
                  <p class="text-sm text-light/70">{service.what}</p>
                </div>

                <!-- For whom -->
                <div class="min-h-[120px] border-b border-light/10 py-4">
                  <div class="mb-1 flex items-center gap-2">
                    <div class="flex h-5 w-5 items-center justify-center rounded-full bg-accent/10">
                      <svg class="h-3 w-3 text-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                      </svg>
                    </div>
                    <span class="text-xs font-semibold text-light/80">{t('services.label.forWhom')}</span>
                  </div>
                  <p class="text-sm text-light/70">{service.forWhom}</p>
                </div>

                <!-- Results -->
                <div class="min-h-[120px] pt-4">
                  <div class="mb-1 flex items-center gap-2">
                    <div class="flex h-5 w-5 items-center justify-center rounded-full bg-accent/10">
                      <svg class="h-3 w-3 text-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                      </svg>
                    </div>
                    <span class="text-xs font-semibold text-light/80">{t('services.label.result')}</span>
                  </div>
                  <p class="text-sm text-light/70">{service.result}</p>
                </div>
              </div>

              <!-- CTA -->
              <div class="mt-6 flex items-center justify-center">
                <span class="inline-flex items-center gap-2 rounded-lg bg-accent/10 px-5 py-2.5 text-sm font-semibold text-accent transition-all duration-300 ease-out group-hover:bg-accent group-hover:text-light">
                  {t('services.learnMore')}
                  <svg class="h-4 w-4 transition-transform duration-300 ease-out group-hover:translate-x-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                  </svg>
                </span>
              </div>
            </div>
          </a>
        ))}
      </div>

      <!-- Price and subtitle at bottom -->
      <div class="mt-8 md:mt-10 text-center">
        <div class="mb-3 flex items-center justify-center gap-2">
          <svg class="h-5 w-5 text-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span class="text-sm font-semibold text-light/80">{t('services.label.price')}:</span>
          <span class="text-xl font-bold text-accent">{t('services.price')}</span>
        </div>
        <p class="text-base md:text-lg text-light/60">
          {t('services.subtitle')}
        </p>
      </div>
    </div>
  </div>
</section>

<script>
  function initServiceCards() {
    const cards = document.querySelectorAll('[data-service-card]');

    cards.forEach((card) => {
      const trigger = card.querySelector('[data-service-trigger]');
      const content = card.querySelector('[data-service-content]') as HTMLElement;
      const icon = card.querySelector('[data-service-icon]') as HTMLElement;

      if (!trigger || !content || !icon) return;

      let isOpen = false;

      trigger.addEventListener('click', (e) => {
        e.preventDefault();
        isOpen = !isOpen;

        // Close other cards
        if (isOpen) {
          cards.forEach((otherCard) => {
            if (otherCard !== card) {
              const otherContent = otherCard.querySelector('[data-service-content]') as HTMLElement;
              const otherIcon = otherCard.querySelector('[data-service-icon]') as HTMLElement;
              if (otherContent && otherIcon) {
                otherContent.style.gridTemplateRows = '0fr';
                otherIcon.style.transform = 'rotate(0deg)';
                otherCard.classList.remove('border-accent/30');
                otherCard.classList.add('border-light/10');
              }
            }
          });
        }

        // Toggle current card
        if (isOpen) {
          content.style.gridTemplateRows = '1fr';
          icon.style.transform = 'rotate(180deg)';
          card.classList.remove('border-light/10');
          card.classList.add('border-accent/30');

          // Scroll to center after animation
          setTimeout(() => {
            const cardElement = card as HTMLElement;
            const cardRect = cardElement.getBoundingClientRect();
            const cardCenter = cardRect.top + cardRect.height / 2;
            const viewportCenter = window.innerHeight / 2;
            const scrollOffset = cardCenter - viewportCenter;

            window.scrollBy({
              top: scrollOffset,
              behavior: 'smooth'
            });
          }, 350);
        } else {
          content.style.gridTemplateRows = '0fr';
          icon.style.transform = 'rotate(0deg)';
          card.classList.remove('border-accent/30');
          card.classList.add('border-light/10');
        }
      });
    });
  }

  initServiceCards();
  document.addEventListener('astro:after-swap', initServiceCards);
</script>
