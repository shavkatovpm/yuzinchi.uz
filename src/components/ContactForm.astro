---
import { getLangFromUrl, useTranslations } from '../i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const experienceYears = [
  { value: 'less-than-1', label: lang === 'uz' ? '1 yildan kam' : lang === 'ru' ? 'Менее 1 года' : 'Less than 1 year' },
  { value: '1-3', label: lang === 'uz' ? '1-3 yil' : lang === 'ru' ? '1-3 года' : '1-3 years' },
  { value: '3-7', label: lang === 'uz' ? '3-7 yil' : lang === 'ru' ? '3-7 лет' : '3-7 years' },
  { value: '7+', label: lang === 'uz' ? '7+ yil' : lang === 'ru' ? '7+ лет' : '7+ years' }
];
---

<form id="contact-form" class="space-y-6">
  <div class="grid gap-6 sm:grid-cols-2">
    <!-- Name -->
    <div>
      <label for="name" class="mb-2 block text-sm font-medium text-light">
        {t('contact.name')} <span class="text-accent">*</span>
      </label>
      <input
        type="text"
        id="name"
        name="name"
        required
        class="w-full rounded-lg border border-light/10 bg-dark px-4 py-3 text-light placeholder-light/40 transition-colors focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/20"
        placeholder={lang === 'uz' ? 'Ismingizni kiriting' : lang === 'ru' ? 'Введите ваше имя' : 'Enter your name'}
      />
    </div>

    <!-- Phone -->
    <div>
      <label for="phone" class="mb-2 block text-sm font-medium text-light">
        {t('contact.phone')} <span class="text-accent">*</span>
      </label>
      <div class="flex">
        <span class="inline-flex items-center rounded-l-lg border border-r-0 border-light/10 bg-light/5 px-4 py-3 text-light/60">
          +998
        </span>
        <input
          type="tel"
          id="phone"
          name="phone"
          required
          maxlength="12"
          class="w-full rounded-r-lg border border-light/10 bg-dark px-4 py-3 text-light placeholder-light/40 transition-colors focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/20"
          placeholder="90 123 45 67"
        />
      </div>
    </div>
  </div>

  <!-- Business Name -->
  <div>
    <label for="business-name" class="mb-2 block text-sm font-medium text-light">
      {lang === 'uz' ? 'Biznesingiz nomi' : lang === 'ru' ? 'Название бизнеса' : 'Business name'} <span class="text-accent">*</span>
    </label>
    <input
      type="text"
      id="business-name"
      name="business-name"
      required
      class="w-full rounded-lg border border-light/10 bg-dark px-4 py-3 text-light placeholder-light/40 transition-colors focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/20"
      placeholder={lang === 'uz' ? 'Biznesingiz nomini kiriting' : lang === 'ru' ? 'Введите название бизнеса' : 'Enter your business name'}
    />
  </div>

  <!-- Business Experience -->
  <div>
    <label for="experience" class="mb-2 block text-sm font-medium text-light">
      {lang === 'uz' ? 'Qachondan beri shug\'ullanasiz?' : lang === 'ru' ? 'Как давно вы занимаетесь бизнесом?' : 'How long have you been in business?'} <span class="text-accent">*</span>
    </label>
    <select
      id="experience"
      name="experience"
      required
      class="w-full rounded-lg border border-light/10 bg-dark px-4 py-3 text-light transition-colors focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/20"
    >
      <option value="" disabled selected>
        {lang === 'uz' ? 'Tanlang...' : lang === 'ru' ? 'Выберите...' : 'Select...'}
      </option>
      {experienceYears.map((year) => (
        <option value={year.value}>{year.label}</option>
      ))}
    </select>
  </div>

  <!-- Message -->
  <div>
    <label for="message" class="mb-2 block text-sm font-medium text-light">
      {t('contact.message')} <span class="text-accent">*</span>
    </label>
    <textarea
      id="message"
      name="message"
      rows="4"
      required
      class="w-full resize-none rounded-lg border border-light/10 bg-dark px-4 py-3 text-light placeholder-light/40 transition-colors focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/20"
      placeholder={lang === 'uz' ? 'Biznesingiz haqida qisqacha yozib keting' : lang === 'ru' ? 'Расскажите коротко о вашем бизнесе' : 'Tell us briefly about your business'}
    ></textarea>
  </div>

  <!-- Submit Button -->
  <button
    type="submit"
    class="inline-flex h-12 w-full items-center justify-center gap-2 rounded-lg bg-accent px-8 text-base font-semibold text-light shadow-lg shadow-accent/25 transition-all hover:bg-accent/90 hover:shadow-xl hover:shadow-accent/30 disabled:cursor-not-allowed disabled:opacity-50 sm:w-auto"
  >
    <span id="submit-text">{t('contact.submit')}</span>
    <svg id="submit-spinner" class="hidden h-5 w-5 animate-spin" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
  </button>

  <!-- Success Message -->
  <div id="success-message" class="hidden rounded-lg bg-green-900/30 p-4 text-green-400">
    {lang === 'uz' ? '✓ Xabaringiz yuborildi! Tez orada siz bilan bog\'lanamiz.' : lang === 'ru' ? '✓ Сообщение отправлено! Мы скоро свяжемся с вами.' : '✓ Message sent! We will contact you soon.'}
  </div>

  <!-- Error Message -->
  <div id="error-message" class="hidden rounded-lg bg-red-900/30 p-4 text-red-400">
    {lang === 'uz' ? '✗ Xatolik yuz berdi. Iltimos, qaytadan urinib ko\'ring.' : lang === 'ru' ? '✗ Произошла ошибка. Пожалуйста, попробуйте снова.' : '✗ An error occurred. Please try again.'}
  </div>
</form>

<script>
  // Google Apps Script Web App URL (to be replaced with actual URL)
  const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzhyuLzYwMRMIJt1OneHlyEGm4TtcceSeUQAHdr5z-SLUQhjY_VMLMarIXe5Qv5aiqm3w/exec';

  function initContactForm() {
    const form = document.getElementById('contact-form');
    const phoneInput = document.getElementById('phone') as HTMLInputElement;
    const submitText = document.getElementById('submit-text');
    const submitSpinner = document.getElementById('submit-spinner');
    const successMessage = document.getElementById('success-message');
    const errorMessage = document.getElementById('error-message');

    if (!form) return;

    // Phone number formatting
    if (phoneInput) {
      phoneInput.addEventListener('input', (e) => {
        const target = e.target as HTMLInputElement;
        // Remove all non-digits
        let value = target.value.replace(/\D/g, '');

        // Format: XX XXX XX XX
        if (value.length > 0) {
          let formatted = '';
          if (value.length > 0) formatted += value.substring(0, 2);
          if (value.length > 2) formatted += ' ' + value.substring(2, 5);
          if (value.length > 5) formatted += ' ' + value.substring(5, 7);
          if (value.length > 7) formatted += ' ' + value.substring(7, 9);
          target.value = formatted;
        }
      });
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Reset messages
      successMessage?.classList.add('hidden');
      errorMessage?.classList.add('hidden');

      // Show loading state
      submitText?.classList.add('hidden');
      submitSpinner?.classList.remove('hidden');

      const formData = new FormData(form as HTMLFormElement);
      const phoneValue = formData.get('phone') as string;
      const data = {
        name: formData.get('name'),
        phone: '998 ' + phoneValue,
        businessName: formData.get('business-name'),
        experience: formData.get('experience'),
        message: formData.get('message'),
        timestamp: new Date().toISOString()
      };

      try {
        // If Google Script URL is not set, show success (for demo)
        if (GOOGLE_SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL') {
          // Demo mode - just show success
          await new Promise(resolve => setTimeout(resolve, 1000));
          successMessage?.classList.remove('hidden');
          (form as HTMLFormElement).reset();
        } else {
          // Send to Google Apps Script
          const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
          });

          successMessage?.classList.remove('hidden');
          (form as HTMLFormElement).reset();
        }
      } catch (error) {
        console.error('Error:', error);
        errorMessage?.classList.remove('hidden');
      } finally {
        // Hide loading state
        submitText?.classList.remove('hidden');
        submitSpinner?.classList.add('hidden');
      }
    });
  }

  initContactForm();
  document.addEventListener('astro:after-swap', initContactForm);
</script>
